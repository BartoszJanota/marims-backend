<html>
    <head>
        <script src='socket.io/socket.io.js'></script>
        <script>
			console.log('Connecting to websocket at url ' + location.host + '/browser' + location.pathname);
            var socket = io.connect('http://' + location.host + '/browser' + location.pathname);
		
			var imageWidth = 500;
			var imageHeight = 700;
		
            var refresh = function(image) {
                if(image !== null && image !== undefined) {
                    var screen = document.getElementById('screen');
                    this.init();

                    screen.src = 'data:image/jpg;base64,' + image;
                }
            };

            socket.on('refresh', function(data){
                console.log('Refreshing');
                if(data !== null && data !== undefined){
                    refresh(data.image);
                }
            });

            socket.on('start', function(){
                console.log('Starting');
            });
			
			var gestureModeActive = false;
			
			this.init = function() {
				var screen = document.getElementById('screen');
				screen.onclick = function(event){
					if(event.pageX != 0 && event.pageY != 0) {
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);
						socket.emit('click', {xPos: x, yPos: y});
					}
				};
				screen.oncontextmenu = function(event) {
					if(event.pageX != 0 && event.pageY != 0) {
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);
						socket.emit('rightClick', {xPos: x, yPos: y});
						return false;
					}
				};
				screen.ondragstart = function(event){
					if(event.pageX != 0 && event.pageY != 0) {
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);				
						socket.emit('dragStart', {xPos: x, yPos: y});
						gestureModeActive = true;
					}
					return false; 
				};
				screen.onmousemove = function(event){
					if(gestureModeActive && event.pageX != 0 && event.pageY != 0) {
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);				
						socket.emit('mouseMove', {xPos: x, yPos: y});
					}
				};
				screen.onmouseout = function(event){
					if (gestureModeActive){
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);
						socket.emit('mouseUp', {xPos: x, yPos: y});
						gestureModeActive = false;
					}
				};
				screen.onmouseup = function(event){
					if (gestureModeActive){
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);
						socket.emit('mouseUp', {xPos: x, yPos: y});
						gestureModeActive = false;
					}
				};
			}
        </script>
    </head>

    <body onLoad="init()">
        <img id="screen" src="/image" style="height:90%;margin:0px auto;display:block"/>
    </body>
</html>