<html>
    <head>
        <script src='socket.io/socket.io.js'></script>
        <script>
            var lastScreenWidth = 0;
            var lastScreenHeight = 0;

            var refresh = function(image, screenWidth, screenHeight) {
                if(image !== null && image !== undefined) {
                    var screen = document.getElementById('screen');

                    if(screenWidth !== lastScreenWidth || screenHeight !== lastScreenHeight){
                        refreshImageState(screenWidth, screenHeight);
                    }

                    lastScreenWidth = screenWidth;
                    lastScreenHeight = screenHeight;

                    screen.src = 'data:image/jpg;base64,' + image;
                }
            };

            console.log('Connecting to websocket at url ' + 'http://' + location.host + '/browser' + location.pathname);

            var socket = io.connect('http://' + location.host + '/browser' + location.pathname);

            socket.on('refresh', function(data){
                console.log('Refreshing');
                if(data !== null && data !== undefined){
                    refresh(data.image, data.screenWidth, data.screenHeight);
                }
            });

            socket.on('debug', function(data){
                console.log(data);
            });
			
			var gestureModeActive = false;
			
			var refreshImageState = function(imageWidth, imageHeight) {
				var screen = document.getElementById('screen');
				screen.onclick = function(event){
					if(event.pageX != 0 && event.pageY != 0) {
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);
						socket.emit('click', {xPos: x, yPos: y});
					}
				};
				screen.oncontextmenu = function(event) {
					if(event.pageX != 0 && event.pageY != 0) {
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);
						socket.emit('rightClick', {xPos: x, yPos: y});
						return false;
					}
				};
				screen.ondragstart = function(event){
					if(event.pageX != 0 && event.pageY != 0) {
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);				
						socket.emit('dragStart', {xPos: x, yPos: y});
						gestureModeActive = true;
					}
					return false; 
				};
				screen.onmousemove = function(event){
					if(gestureModeActive && event.pageX != 0 && event.pageY != 0) {
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);				
						socket.emit('mouseMove', {xPos: x, yPos: y});
					}
				};
				screen.onmouseout = function(event){
					if (gestureModeActive){
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);
						socket.emit('mouseUp', {xPos: x, yPos: y});
						gestureModeActive = false;
					}
				};
				screen.onmouseup = function(event){
					if (gestureModeActive){
						var x = Math.floor(event.offsetX/event.srcElement.width*imageWidth);
						var y = Math.floor(event.offsetY/event.srcElement.height*imageHeight);
						socket.emit('mouseUp', {xPos: x, yPos: y});
						gestureModeActive = false;
					}
				};
			}
        </script>
    </head>

    <body>
        <img id="screen" src="/image" style="height:90%;margin:0px auto;display:block"/>
    </body>
</html>