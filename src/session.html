<html>
    <head>
        <script src='socket.io/socket.io.js'></script>
        <script>
			console.log('Connecting to websocket at url ' + location.host + '/browser' + location.pathname);
            var socket = io.connect('http://' + location.host + '/browser' + location.pathname);
			
			var phoneFrameImageWidth = 1690;
			var phoneFrameImageHeight = 2857;
			var phoneFrameScreenWidth = 1080;
			var phoneFrameScreenHeight = 1920;
			var phoneFrameScreenOffsetX = 304;
			var phoneFrameScreenOffsetY = 436;
			
			var phoneFrameScreenPercentageWidth = phoneFrameScreenWidth/phoneFrameImageWidth;
			var phoneFrameScreenPercentageHeight = phoneFrameScreenHeight/phoneFrameImageHeight;
			var phoneFrameScreenPercentageOffsetX = phoneFrameScreenOffsetX/phoneFrameImageWidth;
			var phoneFrameScreenPercentageOffsetY = phoneFrameScreenOffsetY/phoneFrameImageHeight;
			
            var refresh = function(image, screenWidth, screenHeight) {
                if(image !== null && image !== undefined) {
                    var screen = document.getElementById('screen');
                    this.init(image, screenWidth, screenHeight);

                    screen.src = 'data:image/jpg;base64,' + image;
                }
            };

            console.log('Connecting to websocket at url ' + 'http://' + location.host + '/browser' + location.pathname);

            var socket = io.connect('http://' + location.host + '/browser' + location.pathname);

            socket.on('refresh', function(data){
                console.log('Refreshing');
                if(data !== null && data !== undefined){
                    refresh(data.image, data.screenWidth, data.screenHeight);
                }
            });

            socket.on('debug', function(data){
                console.log(data);
            });
			
			var gestureModeActive = false;

            var lastEvent = null;
			
			this.init = function(image, screenWidth, screenHeight) {			
				var canvas = document.getElementById("canvas");
				
				var phoneFrameRealHeight = window.innerHeight*0.9;
				var phoneFrameRealWidth = phoneFrameRealHeight * phoneFrameScreenPercentageHeight * (screenWidth/screenHeight) / phoneFrameScreenPercentageWidth;
				
				canvas.height = phoneFrameRealHeight;
				canvas.width = phoneFrameRealWidth;
				var ctx = canvas.getContext("2d");
				var img = document.getElementById("phone");
				
				ctx.drawImage(img, 0, 0, phoneFrameRealWidth, phoneFrameRealHeight);
				
				var phoneScreenRealHeight = phoneFrameRealHeight * phoneFrameScreenPercentageHeight;
				var phoneScreenRealWidth = phoneFrameRealWidth * phoneFrameScreenPercentageWidth;
				var phoneScreenOffsetRealHeight = phoneFrameScreenPercentageOffsetY * phoneFrameRealHeight;
				var phoneScreenOffsetRealWidth = phoneFrameScreenPercentageOffsetX * phoneFrameRealWidth;
				var img2 = document.getElementById("view");
				if (image !== null && image !== undefined) {
					img2 = document.createElement("img");
					img2.src = 'data:image/jpg;base64,' + image;
				}
				ctx.drawImage(img2, phoneScreenOffsetRealWidth, phoneScreenOffsetRealHeight, phoneScreenRealWidth, phoneScreenRealHeight);
				
				var screen = document.getElementById('canvas');
				var screenLeftBorder = phoneScreenOffsetRealWidth;
				var screenRightBorder = phoneScreenOffsetRealWidth + phoneScreenRealWidth;
				var screenTopBorder = phoneScreenOffsetRealHeight;
				var screenBottomBorder = phoneScreenOffsetRealHeight + phoneScreenRealHeight;
				screen.onmousedown = function(event){
					if(event.pageX !== 0 && event.pageY !== 0) {
						var screenX = event.offsetX - screenLeftBorder;
						var screenY = event.offsetY - screenTopBorder;
						if (screenX >= 0 && screenX <= phoneScreenRealWidth && screenY >= 0 && screenY <= phoneScreenRealHeight) {
							var x = Math.floor(screenX/phoneScreenRealWidth*screenWidth);
							var y = Math.floor(screenY/phoneScreenRealHeight*screenHeight);
                            var newEvent = {
                                x: x,
                                y: y,
                                type: 'DOWN'
                            }
                            if(lastEvent === undefined ||
                                lastEvent === null ||
                                lastEvent.x !== newEvent.x ||
                                lastEvent.y !== newEvent.y ||
                                lastEvent.type !== newEvent.type){

                                lastEvent = newEvent;
    							socket.emit('mouseDown', {
                                    xPos: x, 
                                    yPos: y,
                                    time: Date.now()
                                });
    							gestureModeActive = true;
    							isMouseOverScreen = true;
    							console.log('down', x, y);
                            }
						}
					}
				};
				screen.onmousemove = function(event){
					if(gestureModeActive === true && event.pageX !== 0 && event.pageY !== 0) {
						var screenX = event.offsetX - screenLeftBorder;
						var screenY = event.offsetY - screenTopBorder;
						if (screenX >= 0 && screenX <= phoneScreenRealWidth && screenY >= 0 && screenY <= phoneScreenRealHeight) {
							var x = Math.floor(screenX/phoneScreenRealWidth*screenWidth);
							var y = Math.floor(screenY/phoneScreenRealHeight*screenHeight);
                            var newEvent = {
                                x: x,
                                y: y,
                                type: 'MOVE'
                            }
                            if(lastEvent === undefined ||
                                lastEvent === null ||
                                lastEvent.x !== newEvent.x ||
                                lastEvent.y !== newEvent.y ||
                                lastEvent.type !== newEvent.type){

                                lastEvent = newEvent;
    							socket.emit('mouseMove', {
                                    xPos: x, 
                                    yPos: y,
                                    time: Date.now()
                                });
    							console.log('move', x, y);
                            }
						} else if (screenX < 0 || screenX > phoneScreenRealWidth || screenY < 0 || screenY > phoneScreenRealHeight){
							var x = Math.floor(screenX/phoneScreenRealWidth*screenWidth);
							var y = Math.floor(screenY/phoneScreenRealHeight*screenHeight);
                            var newEvent = {
                                x: x,
                                y: y,
                                type: 'UP'
                            }
                            if(lastEvent === undefined ||
                                lastEvent === null ||
                                lastEvent.x !== newEvent.x ||
                                lastEvent.y !== newEvent.y ||
                                lastEvent.type !== newEvent.type){

                                lastEvent = newEvent;
    							socket.emit('mouseUp', {
                                    xPos: x, 
                                    yPos: y,
                                    time: Date.now()
                                });
    							gestureModeActive = false;
    							console.log('out', x, y);
                            }
						}
					}
				};
				screen.onmouseup = function(event){
					if (gestureModeActive){
						var screenX = event.offsetX - screenLeftBorder;
						var screenY = event.offsetY - screenTopBorder;
						if (screenX >= 0 && screenX <= phoneScreenRealWidth && screenY >= 0 && screenY <= phoneScreenRealHeight) {
							var x = Math.floor(screenX/phoneScreenRealWidth*screenWidth);
							var y = Math.floor(screenY/phoneScreenRealHeight*screenHeight);
                            var newEvent = {
                                x: x,
                                y: y,
                                type: 'UP'
                            }
                            if(lastEvent !== undefined ||
                                lastEvent !== null ||
                                lastEvent.x !== newEvent.x ||
                                lastEvent.y !== newEvent.y ||
                                lastEvent.type !== newEvent.type){

                                lastEvent = newEvent;
    							socket.emit('mouseUp', {
                                    xPos: x, 
                                    yPos: y,
                                    time: Date.now()
                                });
    							console.log('up', x, y);
                            }
						}
						gestureModeActive = false;
					}
				};
			}
        </script>
    </head>

    <body id="body" onLoad="init(null, 1080, 1920)" style="height: 100%;">
		<div>
			<img id="phone" src="phoneFrame.png" hidden/>
			<img id="view" src="/image" hidden/>
			<canvas id="canvas" width="700" height="700"></canvas>
		</div>
    </body>
</html>